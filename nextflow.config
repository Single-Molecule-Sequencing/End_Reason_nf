/*
 * Nextflow configuration file for End Reason Tagging Pipeline
 */

// Manifest information
manifest {
    name            = 'end_reason_nf'
    author          = 'kmathew (imported by gregfar)'
    homePage        = 'https://github.com/Single-Molecule-Sequencing/End_Reason_nf'
    description     = 'Pipeline to tag BAM files with end_reason metadata from POD5 files'
    mainScript      = 'main.nf'
    nextflowVersion = '>=21.04.0'
    version         = '1.0.0'
}

// Default parameters
params {
    // Input/Output
    pod5_dir = null
    pod5_json = null
    bam_input = null
    outdir = './results'
    write_pod5_json = null
    log_level = 'INFO'

    // Help
    help = false
}

// Process configuration
process {
    // Default process settings
    errorStrategy = 'retry'
    maxRetries = 2

    // Resource requirements for TAG_END_REASON process
    withName: TAG_END_REASON {
        cpus = 2
        memory = 4.GB
        time = 2.h
    }
}

// Executor configuration
executor {
    name = 'local'
    cpus = 4
    memory = '8 GB'
}

// Conda configuration
conda {
    enabled = false  // Disabled by default, enable in profiles as needed
    useMamba = false
    createTimeout = '1 h'
}

// Docker configuration
docker {
    enabled = true  // Enabled by default for EPI2ME Desktop
    runOptions = '-u $(id -u):$(id -g)'
}

// Default container for all processes
process.container = 'ghcr.io/single-molecule-sequencing/end-reason-nf:latest'

// Profile configurations
profiles {
    // Standard profile (default - uses Docker)
    standard {
        process.executor = 'local'
        docker.enabled = true
        process.container = 'ghcr.io/single-molecule-sequencing/end-reason-nf:latest'
    }

    // Docker profile (explicit docker - same as standard)
    docker {
        docker.enabled = true
        process.container = 'ghcr.io/single-molecule-sequencing/end-reason-nf:latest'
        process.executor = 'local'
    }

    // Conda profile (explicit conda usage)
    conda {
        process.executor = 'local'
        conda.enabled = true
        process.conda = "${projectDir}/envs/tagger.yaml"
    }

    // Local profile (explicit local execution)
    local {
        process.executor = 'local'
        conda.enabled = true
        process.conda = "${projectDir}/envs/tagger.yaml"
    }

    // SLURM profile for HPC execution
    slurm {
        process.executor = 'slurm'
        process.queue = 'standard'
        process.clusterOptions = '--account=atheylab'
        conda.enabled = true
        process.conda = "${projectDir}/envs/tagger.yaml"

        // SLURM-specific process settings
        process {
            withName: TAG_END_REASON {
                cpus = 4
                memory = 8.GB
                time = 4.h
            }
        }
    }

    // Test profile with minimal resources
    test {
        params.outdir = './test_results'
        process {
            withName: TAG_END_REASON {
                cpus = 1
                memory = 2.GB
                time = 30.m
            }
        }
    }
}

// Report configuration
report {
    enabled = true
    file = "${params.outdir}/reports/execution_report.html"
    overwrite = true
}

timeline {
    enabled = true
    file = "${params.outdir}/reports/timeline.html"
    overwrite = true
}

trace {
    enabled = true
    file = "${params.outdir}/reports/trace.txt"
    overwrite = true
}

dag {
    enabled = true
    file = "${params.outdir}/reports/dag.html"
    overwrite = true
}
